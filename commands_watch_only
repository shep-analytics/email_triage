#!/usr/bin/env bash
set -euo pipefail

# Call /gmail/watch and /health on a private Cloud Run service using SA impersonation.
# Copy/paste or run:  bash commands_watch_only

PROJECT_ID=inboximp-email-triage
REGION=us-central1
SERVICE=email-triage
RUNTIME_SA=email-triage-runner@${PROJECT_ID}.iam.gserviceaccount.com

gcloud config set project "${PROJECT_ID}"

RUN_URL=$(gcloud run services describe "${SERVICE}" \
  --region "${REGION}" \
  --project "${PROJECT_ID}" \
  --format='value(status.url)')
echo "RUN_URL=${RUN_URL}"

USER_EMAIL=$(gcloud config get-value account 2>/dev/null || true)
gcloud iam service-accounts add-iam-policy-binding "${RUNTIME_SA}" \
  --member="user:${USER_EMAIL}" \
  --role="roles/iam.serviceAccountTokenCreator" \
  --project "${PROJECT_ID}" || true

ID_TOKEN=$(gcloud auth print-identity-token \
  --impersonate-service-account="${RUNTIME_SA}" \
  --audiences="${RUN_URL}")

echo "Starting Gmail watch..."
curl -fsS -H "Authorization: Bearer ${ID_TOKEN}" -X POST "${RUN_URL}/gmail/watch" || true
echo "Health check:"
curl -fsS -H "Authorization: Bearer ${ID_TOKEN}" "${RUN_URL}/healthz" || \
curl -fsS -H "Authorization: Bearer ${ID_TOKEN}" "${RUN_URL}/health" || true

